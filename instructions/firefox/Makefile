# Generate a JSON file with the IonMonkey lowering for every Wasm SIMD
# instruction.
all: json

# Emit the code generated by IonMonkey into hex-encoded files.
SRCS=$(wildcard ../wat/*.wat)
HEX=$(SRCS:../wat/%.wat=out/%.hex)
hex: $(HEX)
out/%.hex: ../wat/%.wat out/js
	out/js compile.js $< > $@

# Disassemble the hex-encoded code and serialize it into JSON files.
JSON=$(HEX:out/%.hex=out/%.json)
json: $(JSON)
out/%.json: out/%.hex
	cat $< | ./disassemble.py > $@

# Retrieve the latest SpiderMonkey shell.
out/js: out
	wget --directory-prefix=$< --no-clobber https://archive.mozilla.org/pub/firefox/nightly/latest-mozilla-central/jsshell-linux-x86_64.zip
	pushd $< && unzip -oq jsshell-linux-x86_64.zip && popd

# Helpful targets.
out:
	mkdir -p out
clean:
	rm -rf out
